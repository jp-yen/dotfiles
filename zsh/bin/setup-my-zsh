#!/bin/bash

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨Oh My Zshã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ˜ãƒ«ãƒ‘ãƒ¼

USER_HOME="$HOME"
ZSH_DIR="$USER_HOME/.zsh"
ZSH_CACHE_DIR="$USER_HOME/.zsh/cache"
SCREEN_DIR="$USER_HOME/.screen"

# Oh My ZshãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
if [ ! -f /usr/share/oh-my-zsh/oh-my-zsh.sh ]; then
    echo "ã‚¨ãƒ©ãƒ¼: Oh My ZshãŒã‚·ã‚¹ãƒ†ãƒ ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo "ç®¡ç†è€…ã«ã‚·ã‚¹ãƒ†ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„"
    exit 1
fi

echo "=========================================="
echo "  å€‹äººç”¨Oh My Zshè¨­å®š"
echo "=========================================="
echo ""

# .zshãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä½œæˆ
echo "~/.zsh ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
mkdir -p "$ZSH_DIR"
mkdir -p "$ZSH_CACHE_DIR"

echo "~/.screen ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
mkdir -p "$SCREEN_DIR"
chmod 700 "$SCREEN_DIR"

# æ—¢å­˜ã®zshãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•
echo "æ—¢å­˜ã®zshãƒ•ã‚¡ã‚¤ãƒ«ã‚’ ~/.zsh/ ã¸ç§»å‹•ã—ã¦ã„ã¾ã™..."

# .zsh_historyã®ç§»å‹•
if [ -f "$USER_HOME/.zsh_history" ]; then
    mv -f "$USER_HOME/.zsh_history" "$ZSH_DIR/history" 2>/dev/null && \
        echo "  âœ“ .zsh_history ã‚’ ~/.zsh/history ã¸ç§»å‹•ã—ã¾ã—ãŸ" || true
fi

# .zcompdumpãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»å‹•
for zcomp in "$USER_HOME"/.zcompdump*; do
    if [ -f "$zcomp" ]; then
        mv -f "$zcomp" "$ZSH_CACHE_DIR/" 2>/dev/null && \
            echo "  âœ“ $(basename "$zcomp") ã‚’ç§»å‹•ã—ã¾ã—ãŸ" || true
    fi
done

# p10k instant promptã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç§»å‹•
if [ -d "$USER_HOME/.cache" ]; then
    for cache_file in "$USER_HOME/.cache"/p10k-*; do
        if [ -f "$cache_file" ]; then
            mv -f "$cache_file" "$ZSH_CACHE_DIR/" 2>/dev/null && \
                echo "  âœ“ $(basename "$cache_file") ã‚’ç§»å‹•ã—ã¾ã—ãŸ" || true
        fi
    done
fi

echo ""

# .zshrcã®ä½œæˆ
if [ ! -f "$USER_HOME/.zshrc" ]; then
    cat > "$USER_HOME/.zshrc" << 'ZSHRC_EOF'
# Powerlevel10kã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æœ‰åŠ¹åŒ–ã€‚~/.zshrcã®å…ˆé ­ä»˜è¿‘ã«é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
if [[ -r "${XDG_CACHE_HOME:-$HOME/.zsh/cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.zsh/cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºã™ã‚‹ã«ã¯ã€p10k configure ã‚’å®Ÿè¡Œã™ã‚‹ã‹ ~/.p10k.zsh ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚
if [[ -f ~/.p10k.zsh ]]; then
  source ~/.p10k.zsh
  # ã‚«ã‚¹ã‚¿ãƒ è¨­å®šï¼ˆ.p10k.zshèª­ã¿è¾¼ã¿å¾Œï¼‰
  [[ ! -f ~/.p10k-post.zsh ]] || source ~/.p10k-post.zsh
fi

# ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã®èª­ã¿è¾¼ã¿
[[ -f ~/.zsh/functions.zsh ]] && source ~/.zsh/functions.zsh

# SSH Agent åˆæœŸåŒ–
if [ -f /etc/ssh-agent-init.sh ]; then
    . /etc/ssh-agent-init.sh
fi
ZSHRC_EOF
    echo "âœ“ .zshrc ã‚’ä½œæˆã—ã¾ã—ãŸ"
    echo ""
else
    echo "è­¦å‘Š: ~/.zshrc ã¯æ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚ã€ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
    echo "      æ—¢å­˜ã®è¨­å®šã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo ""
fi

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢é–¢æ•°ã®è¿½åŠ 
cat > "$ZSH_DIR/functions.zsh" << 'FUNC_EOF'
# Zshã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢é–¢æ•°
clean-zsh-cache() {
    rm -rf ~/.zsh/cache/*
    rm -f ~/.zcompdump*
    echo "âœ“ Zshã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ"
    echo "  å¤‰æ›´ã‚’åæ˜ ã™ã‚‹ã«ã¯ 'exec zsh' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
}
FUNC_EOF

# .p10k-post.zshä½œæˆï¼ˆ.p10k.zshã®å¾Œã«è‡ªå‹•èª­ã¿è¾¼ã¿ï¼‰
cat > "$USER_HOME/.p10k-post.zsh" << 'P10K_POST_EOF'
# .p10k-post.zsh
POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(os_icon host dir vcs newline prompt_char)

if [[ $UID == 0 ]]; then
  typeset -g POWERLEVEL9K_HOST_FOREGROUND=1
  typeset -g POWERLEVEL9K_HOST_BACKGROUND=0
  typeset -g POWERLEVEL9K_HOST_TEMPLATE='%nðŸš¨%m'
  typeset -g POWERLEVEL9K_HOST_VISUAL_IDENTIFIER_EXPANSION='ðŸš¨'
else
  typeset -g POWERLEVEL9K_HOST_FOREGROUND=51
  typeset -g POWERLEVEL9K_HOST_BACKGROUND=30
  typeset -g POWERLEVEL9K_HOST_TEMPLATE='%n ðŸ’» %m'
  typeset -g POWERLEVEL9K_HOST_VISUAL_IDENTIFIER_EXPANSION='ðŸ³'
fi

P10K_POST_EOF

echo "âœ“ .p10k-post.zsh ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆã‚«ã‚¹ã‚¿ãƒ è¨­å®šï¼‰"
echo ""

echo "======================================"
echo "  ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo "======================================"
echo ""

if [ ! -f "$USER_HOME/.p10k.zsh" ]; then
    echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
    echo "1. 'zsh' ã§zshã‚’èµ·å‹•"
    echo "2. åˆå›žèµ·å‹•æ™‚ã«Powerlevel10kè¨­å®šã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãŒè‡ªå‹•çš„ã«é–‹å§‹ã•ã‚Œã¾ã™"
    echo "3. è¨­å®šå¾Œã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’é©ç”¨:"
    echo "   source ~/.p10k-post.zsh && p10k reload"
    echo "   ã¾ãŸã¯ 'exec zsh' ã§èµ·å‹•"
else
    echo "zshã‚’èµ·å‹•ã—ã¦ãã ã•ã„:"
    echo "  exec zsh"
fi

echo "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«ã‚’zshã«å¤‰æ›´ã™ã‚‹å ´åˆ:"
echo "  chsh -s \$(which zsh)"
echo ""
echo "ä¾¿åˆ©ãªã‚³ãƒžãƒ³ãƒ‰:"
echo "  p10k configure  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å†è¨­å®š"
echo "  clean-zsh-cache - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢"
echo ""
